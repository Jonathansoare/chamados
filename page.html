<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Abertura de chamado</title>
  <link rel="stylesheet" href="styles.css">
</head>
<body>
  <div class="main-content">
    <h1>BEM VINDO AO SISTEMA DE ABERTURA DE CHAMADOS DO MHEX/FC</h1>
    <form id="ticketForm">

      <div class="content-input">
        <label for="name">Nome</label>
        <input type="text" id="name" required>
      </div>

      <div class="content-input">
        <label for="description">Descrição do problema</label>
        <input type="text" id="description" required>
      </div>

      <div class="content-input">
        <label for="section">Seção</label>
        <select id="section" name="section">
          <option value="Selecionar">Selecionar</option>
          <option value="D.A">D.A</option>
          <option value="SIS">SIS</option>
          <option value="Bateria">Bateria</option>
          <option value="Produção Grafica">Produção Grafica</option>
          <option value="Garagem">Garagem</option>
          <option value="Tesouraria">Tesouraria</option>
          <option value="Conformidade">Conformidade</option>
          <option value="Salc">Salc</option>
          <option value="Almox">Almox</option>
          <option value="Fiscalização">Fiscalização</option>
          <option value="Tainacan">Tainacan</option>
          <option value="Museografia">Museografia</option>
          <option value="Saude">Saude</option>
          <option value="Guarnição de serviço">Guarnição de serviço</option>
          <option value="Comsoc">Comsoc</option>
          <option value="S1">S1</option>
          <option value="S2">S2</option>
          <option value="Juridico">Juridico</option>
        </select>
      </div>

      <div class="content-button">
        <button type="submit" onclick="">Abrir chamado</button>
      </div>

    </form>
  </div>

  <script>
    async function obterSessionToken() {
  try {
    // Codifique o login e a senha em Base64
    const base64Login = btoa('OpenTicket:mhex2024');  // Substitua por seu login:senha

    const response = await fetch('http://localhost/glpi/apirest.php/initSession', {
      method: 'GET',
      headers: {
        'Authorization': `Basic ${base64Login}`,  // Autenticação básica com login e senha
        'App-Token': 'hlbQDVuwbiUP0BTOqn4Sx6TaY9qTzLlyO9MBjNkt',  // Seu App-Token
        'Content-Type': 'application/json'
      }
    });

    const result = await response.json();
    
    if (response.ok) {
      console.log('Sessão iniciada com sucesso. Token de sessão:', result.session_token);
      return result.session_token;  // Retorna o token da sessão
    } else {
      console.error('Erro ao iniciar a sessão:', result);
      alert('Erro ao iniciar sessão no GLPI.');
    }
  } catch (error) {
    console.error('Erro na requisição de sessão:', error);
    alert('Erro de conexão ao iniciar a sessão.');
  }
}


    document.getElementById('ticketForm').addEventListener('submit', async function(event) {
      event.preventDefault(); // Evita o comportamento padrão do envio do formulário

      // Captura os dados do formulário
      const name = document.getElementById('name').value;
      const description = document.getElementById('description').value;
      const section = document.getElementById('section').value;

      // Obtem o session_token
      const session_token = await obterSessionToken();
      if (!session_token) {
        alert('Erro ao obter o token de sessão.');
        return;
      }

      // Constrói o corpo da requisição
      const ticketData = {
        input: {
          name: `${name} - ${section}`,
          content: description,
          requesttypes_id: 1,   // Tipo de incidente
          users_id_recipient: 1, // Substitua pelo ID do solicitante
          status: 1, // Status inicial do chamado
          _sections_id: section
        }
      };

      // Envia a requisição para a API do GLPI
      try {
        const response = await fetch('http://localhost/glpi/apirest.php/Ticket/', {
          method: 'POST',
          headers: {
            'Session-Token': session_token,
            'Authorization': '3hRtIe6Qpd1Kh53zEokBbthYnFUYTR9Acy0hqDLX', // Substitua pelo seu User Token
            'App-Token': 'hlbQDVuwbiUP0BTOqn4Sx6TaY9qTzLlyO9MBjNkt',      // Substitua pelo seu App Token
            'Content-Type': 'application/json'
          },
          body: JSON.stringify(ticketData)
        });

        const result = await response.json();
        if (response.ok) {
          alert('Chamado aberto com sucesso!');
          console.log(result);
        } else {
          alert('Erro ao abrir chamado!');
          console.error(result);
        }
      } catch (error) {
        console.error('Erro na requisição:', error);
        alert('Erro de conexão com o servidor.');
      }
    });
  </script>
</body>
</html>
